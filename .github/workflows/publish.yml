name: Publish Smarty-ui-vite To Npm

on:
  push:
    branches: [main]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org/'
          always-auth: true
      - name: Debug .npmrc
        run: cat .npmrc

      - name: Debug npm version
        run: npm --version
      - name: Install semver
        run: npm install semver

      - name: set ssh key # 临时设置 ssh key
        run: |
          mkdir -p ~/.ssh/
          echo "${{secrets.RUNNER_TOKEN}}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan "github.com" >> ~/.ssh/known_hosts

      - name: Set up Git
        run: |
          git config --global user.email "1763303455@qq.com"
          git config --global user.name "drxiong"

      - name: Auto version increment
        env:
          NODE_AUTH_TOKEN: ${{ secrets.RUNNER_TOKEN }}
        run: |
          current_version=$(node -p "require('~/work/winter_cli/winter_cli/package.json').version")
          new_version=$(node -p "const semver = require('semver'); semver.inc('$current_version', 'patch')")
          npm version --no-git-tag-version patch
          git add .
          git commit -m "Auto version increment"
          git push git@github.com:drxiong/winter_cli.git
        

      - name: Check environment variable
        run: |
          if [ -z "${{ secrets.WINTER_CLI_NPM_AUTH_TOKEN }}" ]; then
            echo "WINTER_CLI_NPM_AUTH_TOKEN is not set."
          else
            echo "WINTER_CLI_NPM_AUTH_TOKEN is set."
          fi

      - name: Publish package
        run: npm set registry https://registry.npmjs.org/ && npm publish --access public --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{secrets.WINTER_CLI_NPM_AUTH_TOKEN}}

